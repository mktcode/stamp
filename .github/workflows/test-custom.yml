name: Test Custom

on:
  workflow_dispatch:
    inputs:
      path:
        required: true
        type: string
        default: '/avatar/fabien.eth'
      target:
        required: false
        type: string
        default: '18'
      redis_version:
        required: false
        type: string
        default: '7'
      pr_id:
        required: true
        type: string
        default: '13'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: ${{ inputs.target }}
          cache: 'yarn'

      - name: Setup Redis
        uses: supercharge/redis-github-action@1.7.0
        with:
          redis-version: ${{ inputs.redis_version }}

      - name: Yarn install
        run: yarn install --frozen-lockfile

      - name: Build
        run: yarn build

      - name: Start
        run: yarn start &

      - name: Fetch image
        id: fetch_image
        run: |
          curl -o image.webp "http://localhost:3008${{ inputs.path }}"

      - name: Convert image to base64
        id: convert_image
        run: |
          echo "::set-output name=image_base64::$(base64 -w 0 image.webp)"
          
      - name: Add comment
        uses: actions/github-script@v6
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NUMBER: ${{ inputs.pr_id }}
        with:
          script: |
            const base64Image = '${{ steps.convert_image.outputs.image_base64 }}';
            const issueNumber = process.env.NUMBER;
            const body = `
              Test result:
              
              ![Fetched Image](data:image/png;base64,${base64Image})
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });
